import{a as e}from"./rolldown-runtime-Cn8xt2Gj.js";import{$ as t,C as n,H as r,M as i,N as a,O as o,Q as ee,R as s,T as c,V as te,Z as ne,_ as re,at as l,b as u,et as d,ht as f,it as p,j as ie,k as m,m as ae,pt as h,rt as oe,s as g,tt as _,u as v,z as y}from"./mui-Ec-9_KFF.js";import{a as b}from"./vendor-CfXIGJNW.js";import"./supabase-O-LofRAx.js";import{n as x,t as S}from"./index-D9FOe0EU.js";import{t as se}from"./CardsNews-BW7bhnPN.js";var C=e(f()),w=e(h()),T=()=>{let e=`BucketNews`,{user:f,logout:h}=S(),T=b(),[E,D]=(0,C.useState)([]),[O,k]=(0,C.useState)([]),[A,j]=(0,C.useState)(!1),[M,N]=(0,C.useState)(null),[P,F]=(0,C.useState)({show:!1,message:``,type:`success`}),[I,L]=(0,C.useState)(!1),[R,z]=(0,C.useState)(null),[B,V]=(0,C.useState)(``),[H,U]=(0,C.useState)(0),[W,G]=(0,C.useState)({}),[K,q]=(0,C.useState)({titulo:``,subtitulo:``,contenido:``,imagen:``,categoria:``,destacado:!1});(0,C.useEffect)(()=>{if(!f||f.role!==`reportero`){T(`/login`);return}J(),ce()},[f,T]);let J=async()=>{try{let{data:e,error:t}=await x.from(`posts`).select(`*`).eq(`autor`,f.nombre).order(`fechacreacion`,{ascending:!1});if(t)throw t;if(e&&e.length>0){let{data:t}=await x.from(`secciones`).select(`*`),n=e.map(e=>{let n=t?.find(t=>t.idseccion===e.categoria);return{...e,secciones:n?{nombre:n.nombre}:null}});D(n)}else D([])}catch(e){console.error(`Error al cargar noticias:`,e),Y(`Error al cargar noticias: `+e.message,`error`)}},ce=async()=>{try{let{data:e,error:t}=await x.from(`secciones`).select(`*`).eq(`estado`,!0);if(t)throw t;k(e||[])}catch(e){console.error(`Error al cargar secciones:`,e)}},Y=(e,t=`success`)=>{F({show:!0,message:e,type:t}),setTimeout(()=>F({show:!1,message:``,type:`success`}),4e3)},X=(e=null)=>{if(e){N(e);let t=O.find(t=>t.idseccion===e.categoria);q({titulo:e.titulo,subtitulo:e.subtitulo||``,contenido:e.contenido,imagen:e.imagen||``,categoria:t?.nombre||``,destacado:e.destacado||!1}),e.imagen&&V(e.imagen)}else N(null),q({titulo:``,subtitulo:``,contenido:``,imagen:``,categoria:``,destacado:!1}),V(``),z(null);j(!0)},Z=()=>{j(!1),N(null),q({titulo:``,subtitulo:``,contenido:``,imagen:``,categoria:``,destacado:!1}),z(null),V(``),U(0),G({})},Q=e=>{q({...K,[e.target.name]:e.target.value})},le=e=>{let t=e.target.files?.[0];if(!t)return;z(t);let n=URL.createObjectURL(t);V(n),q(e=>({...e,imagen:``}))},ue=()=>{let e={};return K.titulo.trim()||(e.titulo=`El título es obligatorio`),K.contenido.trim()||(e.contenido=`El contenido es obligatorio`),K.categoria||(e.categoria=`La sección es obligatoria`),e},$=async(e,t=25e3,n=`operación`)=>{let r,i=new Promise((e,i)=>{r=setTimeout(()=>{i(Error(`Tiempo de espera excedido (${n})`))},t)});try{return await Promise.race([e,i])}finally{clearTimeout(r)}},de=async t=>{t?.preventDefault?.(),G({});let n=ue();if(Object.keys(n).length){G(n),Y(`Por favor corrige los campos marcados`,`error`);return}try{L(!0);let t=K.imagen;if(R){console.log(`[upload] iniciando subida a Supabase Storage`,{bucket:e});let n=`posts/${Date.now()}_${R.name}`;await $(x.storage.from(e).upload(n,R,{cacheControl:`3600`,upsert:!1}),25e3,`subida de imagen`);let{data:r}=x.storage.from(e).getPublicUrl(n);t=r?.publicUrl||``,U(100),console.log(`[upload] subida completa, url:`,t)}let n=new Date().toISOString(),r=O.find(e=>e.nombre===K.categoria),i={autor:f?.nombre||`Anónimo`,titulo:K.titulo,subtitulo:K.subtitulo||``,categoria:r?.idseccion||null,contenido:K.contenido,imagen:t||``,estado:`Edicion`,destacado:!!K.destacado,fechacreacion:M?M.fechacreacion:n,fechaactualizacion:n};if(M){if(M.estado===`Publicado`||M.estado===`Desactivado`){Y(`No puedes editar una noticia publicada o desactivada`,`error`),L(!1);return}let{error:e}=await $(x.from(`posts`).update(i).eq(`id`,M.id),2e4,`actualización de la noticia`);if(e)throw e;Y(`Noticia actualizada correctamente`)}else{let{data:e,error:t}=await $(x.from(`posts`).insert([i]).select().single(),2e4,`registro de la noticia`);if(t)throw t;Y(`Noticia creada correctamente (pendiente de aprobación)`)}Z(),J()}catch(e){console.error(`[submit] Error:`,e),Y(e?.message||`Error inesperado durante el guardado`,`error`)}finally{L(!1)}};return(0,w.jsxs)(_,{className:`panel-reportero`,children:[(0,w.jsxs)(_,{className:`panel-header`,children:[(0,w.jsxs)(_,{className:`header-content`,children:[(0,w.jsx)(u,{sx:{fontSize:40,color:`#ffd700`}}),(0,w.jsxs)(_,{children:[(0,w.jsx)(p,{variant:`h4`,sx:{color:`#ffd700`,fontWeight:700},children:`Panel de Reportero`}),(0,w.jsxs)(p,{variant:`body2`,sx:{color:`#999`},children:[`Bienvenido, `,f?.nombre]})]})]}),(0,w.jsx)(d,{variant:`outlined`,startIcon:(0,w.jsx)(g,{}),onClick:async()=>{await h(),T(`/login`)},sx:{borderColor:`#ffd700`,color:`#ffd700`,"&:hover":{borderColor:`#ffed4e`,backgroundColor:`rgba(255, 215, 0, 0.1)`}},children:`Cerrar Sesión`})]}),P.show&&(0,w.jsx)(l,{severity:P.type,sx:{mb:3},children:P.message}),(0,w.jsxs)(_,{className:`panel-content`,children:[(0,w.jsxs)(_,{sx:{display:`flex`,justifyContent:`space-between`,alignItems:`center`,mb:3},children:[(0,w.jsx)(p,{variant:`h5`,sx:{color:`#fff`,fontWeight:600},children:`Mis Noticias`}),(0,w.jsx)(d,{variant:`contained`,startIcon:(0,w.jsx)(n,{}),onClick:()=>X(),sx:{background:`linear-gradient(90deg, #ffd700, #ffb200)`,color:`#000`,fontWeight:700,"&:hover":{background:`linear-gradient(90deg, #ffed4e, #ffd700)`}},children:`Nueva Noticia`})]}),A&&(0,w.jsx)(_,{className:`form-card-wrapper`,sx:{mb:4},children:(0,w.jsxs)(t,{elevation:6,className:`form-card`,sx:{backgroundColor:`#1a1a1a`,border:`2px solid #ffd700`,boxShadow:`0 8px 32px rgba(255, 215, 0, 0.15)`},children:[(0,w.jsxs)(ne,{children:[(0,w.jsxs)(m,{spacing:1,sx:{mb:2},children:[(0,w.jsx)(p,{variant:`h5`,component:`div`,sx:{color:`#ffd700`,fontWeight:600},children:M?`Editar Noticia`:`Nueva Noticia`}),(0,w.jsx)(p,{variant:`body2`,sx:{color:`#c0c0c0`},children:M?`Modifica los campos necesarios`:`Las noticias quedarán pendientes de aprobación por un editor`})]}),(0,w.jsxs)(m,{spacing:2,sx:{"& > *":{width:`100%`},"& .MuiTextField-root":{"& .MuiOutlinedInput-root":{color:`#f0f0f0`,backgroundColor:`#0a0a0a`,"& fieldset":{borderColor:`#444`},"&:hover fieldset":{borderColor:`#ffd700`},"&.Mui-focused fieldset":{borderColor:`#ffd700`,borderWidth:`2px`}},"& .MuiInputLabel-root":{color:`#c0c0c0`},"& .MuiInputLabel-root.Mui-focused":{color:`#ffd700`}}},children:[(0,w.jsx)(c,{label:`Título`,name:`titulo`,value:K.titulo,onChange:Q,error:!!W.titulo,helperText:W.titulo,required:!0,fullWidth:!0}),(0,w.jsx)(c,{label:`Subtítulo`,name:`subtitulo`,value:K.subtitulo,onChange:Q,fullWidth:!0}),(0,w.jsxs)(r,{fullWidth:!0,size:`medium`,error:!!W.categoria,sx:{"& .MuiOutlinedInput-root":{color:`#f0f0f0`,backgroundColor:`#0a0a0a`,"& fieldset":{borderColor:`#444`},"&:hover fieldset":{borderColor:`#ffd700`},"&.Mui-focused fieldset":{borderColor:`#ffd700`,borderWidth:`2px`}},"& .MuiInputLabel-root":{color:`#c0c0c0`},"& .MuiInputLabel-root.Mui-focused":{color:`#ffd700`},"& .MuiSvgIcon-root":{color:`#ffd700`}},children:[(0,w.jsx)(s,{id:`section-label`,children:`Sección *`}),(0,w.jsxs)(ie,{labelId:`section-label`,label:`Sección *`,name:`categoria`,value:K.categoria,onChange:Q,input:(0,w.jsx)(i,{label:`Sección *`,startAdornment:(0,w.jsx)(y,{position:`start`,children:(0,w.jsx)(re,{fontSize:`small`})})}),MenuProps:{PaperProps:{sx:{backgroundColor:`#1a1a1a`,border:`1px solid #444`,"& .MuiMenuItem-root":{color:`#f0f0f0`,"&:hover":{backgroundColor:`#2a2a2a`},"&.Mui-selected":{backgroundColor:`#ffd70020`,"&:hover":{backgroundColor:`#ffd70030`}}}}}},children:[(0,w.jsx)(a,{value:``,children:(0,w.jsx)(`em`,{children:`Seleccione una sección`})}),O.map(e=>(0,w.jsx)(a,{value:e.nombre,children:e.nombre},e.idseccion))]}),W.categoria&&(0,w.jsx)(p,{variant:`caption`,sx:{color:`#d32f2f`,ml:2,mt:.5},children:W.categoria})]}),(0,w.jsx)(te,{control:(0,w.jsx)(o,{checked:!!K.destacado,onChange:e=>q(t=>({...t,destacado:e.target.checked})),sx:{"& .MuiSwitch-switchBase.Mui-checked":{color:`#ffd700`},"& .MuiSwitch-switchBase.Mui-checked + .MuiSwitch-track":{backgroundColor:`#ffd700`}}}),label:`Destacado`,sx:{color:`#f0f0f0`}}),(0,w.jsx)(c,{label:`Contenido`,name:`contenido`,value:K.contenido,onChange:Q,error:!!W.contenido,helperText:W.contenido,required:!0,fullWidth:!0,multiline:!0,minRows:4}),(0,w.jsxs)(m,{direction:{xs:`column`,sm:`row`},spacing:2,alignItems:`center`,children:[(0,w.jsxs)(d,{variant:`outlined`,component:`label`,disabled:I,sx:{borderColor:`#ffd700`,color:`#ffd700`,"&:hover":{borderColor:`#ffaa00`,backgroundColor:`#ffd70010`}},children:[`Seleccionar imagen`,(0,w.jsx)(`input`,{type:`file`,accept:`image/*`,hidden:!0,onChange:le})]}),(0,w.jsx)(p,{variant:`body2`,sx:{color:`#c0c0c0`},children:R?R.name:B?`Imagen actual`:`No hay archivo seleccionado`}),H>0&&H<100&&(0,w.jsxs)(p,{variant:`caption`,sx:{color:`#ffd700`},children:[`Subiendo: `,H,`%`]})]}),(0,w.jsx)(_,{children:B||K.imagen?(0,w.jsx)(_,{className:`img-preview-wrapper`,children:(0,w.jsx)(`img`,{src:B||K.imagen,alt:`Vista previa`,className:`img-preview`,onError:e=>e.currentTarget.style.display=`none`})}):(0,w.jsx)(p,{variant:`caption`,color:`text.secondary`,children:`Vista previa de imagen`})})]})]}),(0,w.jsxs)(ee,{sx:{justifyContent:`flex-end`},children:[(0,w.jsx)(d,{variant:`text`,onClick:Z,disabled:I,sx:{color:`#c0c0c0`,"&:hover":{backgroundColor:`#2a2a2a`}},children:`Cancelar`}),(0,w.jsx)(d,{variant:`contained`,onClick:de,sx:{backgroundColor:`#ffd700`,color:`#0a0a0a`,fontWeight:600,"&:hover":{backgroundColor:`#ffaa00`}},disabled:I,children:I?`Guardando...`:M?`Actualizar`:`Crear Noticia`})]})]})}),(0,w.jsx)(_,{className:`noticias-container`,children:E.length===0?(0,w.jsx)(p,{sx:{color:`#999`,textAlign:`center`,py:4,width:`100%`},children:`No has creado ninguna noticia aún`}):E.map(e=>(0,w.jsxs)(_,{className:`noticia-wrapper`,children:[(0,w.jsx)(se,{post:e}),(0,w.jsxs)(_,{className:`noticia-actions`,children:[(0,w.jsx)(oe,{label:e.estado===`Edicion`?`En Edición`:e.estado===`Terminado`?`Terminado - Pendiente de Aprobación`:e.estado===`Publicado`?`Publicado`:`Desactivado`,color:e.estado===`Publicado`?`success`:e.estado===`Terminado`?`info`:e.estado===`Desactivado`?`error`:`default`,size:`small`,sx:{fontWeight:600}}),(e.estado===`Edicion`||e.estado===`Terminado`)&&(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(d,{variant:`contained`,size:`small`,startIcon:(0,w.jsx)(ae,{}),onClick:()=>X(e),sx:{background:`linear-gradient(90deg, #ffd700, #ffb200)`,color:`#000`,fontWeight:700,"&:hover":{background:`linear-gradient(90deg, #ffed4e, #ffd700)`}},children:`Editar`}),e.estado===`Edicion`&&(0,w.jsx)(d,{variant:`outlined`,size:`small`,startIcon:(0,w.jsx)(v,{}),onClick:async()=>{try{let{error:t}=await x.from(`posts`).update({estado:`Terminado`,fechaactualizacion:new Date().toISOString()}).eq(`id`,e.id);if(t)throw t;Y(`Noticia marcada como terminada`),J()}catch{Y(`Error al marcar como terminada`,`error`)}},sx:{borderColor:`#2196F3`,color:`#2196F3`,fontWeight:700,"&:hover":{borderColor:`#1976D2`,backgroundColor:`rgba(33, 150, 243, 0.1)`}},children:`Marcar como Terminado`})]})]})]},e.id))})]})]})};export{T as default};